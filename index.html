<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Mejorado con Voz y Perfil</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0f0f0f;
    color: #fff;
    text-align: center;
  }
  #container {
    max-width: 700px;
    margin: auto;
    padding: 20px;
  }
  h1 { color: #00ffc8; }
  button {
    background: #00ffc8;
    color: #000;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
  }
  input[type=text], input[type=file] {
    padding: 8px;
    border-radius: 5px;
    border: none;
    width: 70%;
  }
  #chatBox {
    width: 100%;
    height: 250px;
    background: #202020;
    overflow-y: auto;
    border-radius: 8px;
    padding: 10px;
    text-align: left;
    margin-top: 10px;
  }
  .profile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 15px 0;
  }
  .profile img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid #00ffc8;
    object-fit: cover;
  }
  #typingStatus {
    font-style: italic;
    color: #888;
    font-size: 0.9em;
  }
  .message-you { color: #00ffc8; }
  .message-friend { color: #ff6a00; }
  audio { display: none; }
</style>
</head>
<body>
<div id="container">
  <h1>Chat Mejorado + Voz</h1>
  <p><strong>Tu ID:</strong> <span id="myId">...</span></p>
  <input id="friendId" type="text" placeholder="ID de tu amigo">
  <button onclick="connectCall()">üìû Llamar</button>
  <br><br>

  <div class="profile">
    <div>
      <p>T√∫: <input id="myName" type="text" placeholder="Tu nombre" value="T√∫" style="width:60px"></p>
      <img id="myPhoto" src="https://via.placeholder.com/80?text=Yo">
      <br>
      <input type="file" id="photoInput" accept="image/*">
    </div>
    <div>
      <p id="friendNameLabel">Amigo</p>
      <img id="friendPhoto" src="https://via.placeholder.com/80?text=Amigo">
    </div>
  </div>

  <button id="toggleEffect">üéõÔ∏è Activar voz hacker</button>
  <button id="muteBtn">üîá Silenciar micr√≥fono</button>

  <div id="chatBox"></div>
  <div id="typingStatus"></div>
  <input type="text" id="messageInput" placeholder="Escribe un mensaje..." onkeydown="checkEnter(event)">
  <button onclick="sendMessage()">Enviar</button>

  <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const myIdSpan = document.getElementById('myId');
const remoteAudio = document.getElementById('remoteAudio');
const chatBox = document.getElementById('chatBox');
const myPhoto = document.getElementById('myPhoto');
const friendPhoto = document.getElementById('friendPhoto');
const photoInput = document.getElementById('photoInput');
const typingStatus = document.getElementById('typingStatus');
const myNameInput = document.getElementById('myName');
const friendNameLabel = document.getElementById('friendNameLabel');

let myStream, currentCall, voiceEffect = false, muted = false, currentConn;

// Historial local
let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
chatHistory.forEach(msg => displayMessage(msg.sender, msg.text, msg.time));

const peer = new Peer();

peer.on('open', id => {
  myIdSpan.textContent = id;
});

async function getAudioStream() {
  return await navigator.mediaDevices.getUserMedia({
    audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
  });
}

peer.on('call', async call => {
  myStream = await getAudioStream();
  call.answer(myStream);
  handleStream(call);
});

peer.on('connection', conn => {
  currentConn = conn;
  conn.on('data', data => {
    if (data.type === 'chat') {
      displayMessage('friend', data.message);
    } else if (data.type === 'photo') {
      friendPhoto.src = data.photo;
    } else if (data.type === 'name') {
      friendNameLabel.textContent = data.name;
    } else if (data.type === 'typing') {
      typingStatus.textContent = data.status ? "Amigo est√° escribiendo..." : "";
    }
  });
});

async function connectCall() {
  const friendId = document.getElementById('friendId').value;
  if (!friendId) return alert("Introduce el ID del amigo");
  myStream = await getAudioStream();
  const call = peer.call(friendId, myStream);
  handleStream(call);
  currentConn = peer.connect(friendId);
}

function handleStream(call) {
  currentCall = call;
  call.on('stream', stream => {
    if (voiceEffect) applyVoiceEffect(stream);
    else remoteAudio.srcObject = stream;
  });
}

function sendMessage() {
  const msg = document.getElementById('messageInput').value.trim();
  if (!msg || !currentConn) return;
  currentConn.send({ type:'chat', message: msg });
  displayMessage('you', msg);
  document.getElementById('messageInput').value = "";
}

function displayMessage(sender, text) {
  const time = new Date().toLocaleTimeString();
  const className = sender === 'you' ? 'message-you' : 'message-friend';
  chatBox.innerHTML += `<p class="${className}"><strong>${sender==='you'?myNameInput.value:'Amigo'}:</strong> ${text} <span style="font-size:0.8em;color:#888;">${time}</span></p>`;
  chatBox.scrollTop = chatBox.scrollHeight;
  // Guardar historial
  chatHistory.push({ sender, text, time });
  localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  if(sender==='friend') playNotification();
}

function playNotification() {
  const audio = new Audio('https://www.soundjay.com/button/beep-07.wav');
  audio.play();
}

photoInput.addEventListener('change', () => {
  const file = photoInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    myPhoto.src = reader.result;
    if (currentConn) currentConn.send({ type:'photo', photo: reader.result });
  };
  reader.readAsDataURL(file);
});

myNameInput.addEventListener('input', () => {
  if(currentConn) currentConn.send({ type:'name', name: myNameInput.value });
});

document.getElementById('toggleEffect').onclick = () => {
  voiceEffect = !voiceEffect;
  alert(voiceEffect ? "Voz hacker ACTIVADA" : "Voz hacker DESACTIVADA");
};

document.getElementById('muteBtn').onclick = () => {
  muted = !muted;
  if(myStream) myStream.getAudioTracks()[0].enabled = !muted;
  document.getElementById('muteBtn').textContent = muted ? "üîä Activar micr√≥fono" : "üîá Silenciar micr√≥fono";
};

function applyVoiceEffect(stream) {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(stream);
  const gainNode = audioCtx.createGain();
  const biquadFilter = audioCtx.createBiquadFilter();
  const pitchShifter = audioCtx.createWaveShaper();
  gainNode.gain.value = 1.5;
  biquadFilter.type = "lowshelf";
  biquadFilter.frequency.value = 300;
  biquadFilter.gain.value = 20;
  source.connect(biquadFilter).connect(gainNode).connect(audioCtx.destination);
}

// Detectar "enter" para enviar
function checkEnter(e) {
  if(e.key === 'Enter') sendMessage();
  if(currentConn) currentConn.send({ type:'typing', status: e.key.length>0 });
}
</script>
</body>
</html>
