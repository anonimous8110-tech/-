<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat con Voz y Perfil</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #0f0f0f; 
      color: #fff; 
      text-align: center; 
    }
    #container { 
      max-width: 700px; 
      margin: auto; 
      padding: 20px; 
    }
    h1 { color: #00ffc8; }
    button {
      background: #00ffc8;
      color: #000;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    input[type=text] {
      padding: 8px;
      border-radius: 5px;
      border: none;
      width: 70%;
    }
    #chatBox {
      width: 100%;
      height: 200px;
      background: #202020;
      overflow-y: auto;
      border-radius: 8px;
      padding: 10px;
      text-align: left;
      margin-top: 10px;
    }
    .profile {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }
    .profile img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #00ffc8;
      object-fit: cover;
    }
    audio {
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Chat con Voz + Perfil</h1>
    <p><strong>Tu ID:</strong> <span id="myId">...</span></p>
    <input id="friendId" type="text" placeholder="ID de tu amigo">
    <button onclick="connectCall()">üìû Llamar</button>
    <br><br>

    <!-- Perfil propio -->
    <div class="profile">
      <div>
        <p>T√∫</p>
        <img id="myPhoto" src="https://via.placeholder.com/80?text=Yo">
        <br>
        <input type="file" id="photoInput" accept="image/*">
      </div>

      <!-- Perfil remoto -->
      <div>
        <p>Amigo</p>
        <img id="friendPhoto" src="https://via.placeholder.com/80?text=Amigo">
      </div>
    </div>

    <button id="toggleEffect">üéõÔ∏è Activar voz hacker</button>
    <button id="muteBtn">üîá Silenciar micr√≥fono</button>

    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>

    <audio id="remoteAudio" autoplay></audio>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const myIdSpan = document.getElementById('myId');
    const remoteAudio = document.getElementById('remoteAudio');
    const chatBox = document.getElementById('chatBox');
    const myPhoto = document.getElementById('myPhoto');
    const friendPhoto = document.getElementById('friendPhoto');
    const photoInput = document.getElementById('photoInput');

    let myStream, currentCall, voiceEffect = false, muted = false;
    let currentConn;

    // Crear PeerJS
    const peer = new Peer();

    peer.on('open', id => {
      myIdSpan.textContent = id;
    });

    // Capturar micr√≥fono con cancelaci√≥n de ruido
    async function getAudioStream() {
      return await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });
    }

    // Responder llamada
    peer.on('call', async call => {
      myStream = await getAudioStream();
      call.answer(myStream);
      handleStream(call);
    });

    // Manejo de conexi√≥n de datos (chat + perfil)
    peer.on('connection', conn => {
      currentConn = conn;
      conn.on('data', data => {
        if (data.type === 'chat') {
          chatBox.innerHTML += `<p><strong>Amigo:</strong> ${data.message}</p>`;
        } else if (data.type === 'photo') {
          friendPhoto.src = data.photo;
        }
      });
    });

    // Llamar a amigo
    async function connectCall() {
      const friendId = document.getElementById('friendId').value;
      if (!friendId) return alert("Introduce el ID del amigo");

      myStream = await getAudioStream();
      const call = peer.call(friendId, myStream);
      handleStream(call);

      // Conexi√≥n de datos para chat y fotos
      currentConn = peer.connect(friendId);
    }

    // Manejar audio remoto
    function handleStream(call) {
      currentCall = call;
      call.on('stream', stream => {
        if (voiceEffect) {
          applyVoiceEffect(stream);
        } else {
          remoteAudio.srcObject = stream;
        }
      });
    }

    // Enviar mensaje de texto
    function sendMessage() {
      const msg = document.getElementById('messageInput').value;
      if (!msg || !currentConn) return;

      currentConn.send({ type: 'chat', message: msg });
      chatBox.innerHTML += `<p><strong>T√∫:</strong> ${msg}</p>`;
      document.getElementById('messageInput').value = "";
    }

    // Enviar foto de perfil
    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        myPhoto.src = reader.result;
        if (currentConn) {
          currentConn.send({ type: 'photo', photo: reader.result });
        }
      };
      reader.readAsDataURL(file);
    });

    // Bot√≥n efecto "voz hacker"
    document.getElementById('toggleEffect').onclick = () => {
      voiceEffect = !voiceEffect;
      alert(voiceEffect ? "Voz hacker ACTIVADA" : "Voz hacker DESACTIVADA");
    };

    // Bot√≥n silenciar micr√≥fono
    document.getElementById('muteBtn').onclick = () => {
      muted = !muted;
      if (myStream) {
        myStream.getAudioTracks()[0].enabled = !muted;
      }
      document.getElementById('muteBtn').textContent = muted ? "üîä Activar micr√≥fono" : "üîá Silenciar micr√≥fono";
    };

    // Efecto de voz hacker
    function applyVoiceEffect(stream) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);
      const gainNode = audioCtx.createGain();
      const biquadFilter = audioCtx.createBiquadFilter();

      gainNode.gain.value = 1.3;
      biquadFilter.type = "lowshelf";
      biquadFilter.frequency.value = 300;
      biquadFilter.gain.value = 20;

      source.connect(biquadFilter).connect(gainNode).connect(audioCtx.destination);
    }
  </script>
</body>
</html>
